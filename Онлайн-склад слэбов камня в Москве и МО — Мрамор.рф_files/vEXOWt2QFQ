window.__jivoOnError=function(e){if(-1===navigator.userAgent.search(/google/gi)&&-1===navigator.userAgent.search(/\+http:\/\/yandex\.com\/bots/gi))try{var t=jivo_config&&jivo_config.base_url,n="main";t&&(-1!==t.indexOf("jvs")&&(n="jvs"),-1!==t.indexOf("ru1")&&(n="ru1"),-1!==t.indexOf("ya")&&(n="ya"));var o=window.location.protocol+"//err.jivosite.com/widget",r="POST",i={widget:"true",widget_version:window.jivo_version,level:2,url:window.location.href,user_agent:navigator.userAgent,lineNumber:e&&e.lineNumber,fileName:e&&e.fileName,column:e&&e.columnNumber,full_message:e&&e.stack,short_message:e&&e.message,shard:n},a=new XMLHttpRequest;"withCredentials"in a?a.open(r,o,!0):"undefined"!=typeof XDomainRequest&&(a=new XDomainRequest).open(r,o),a.setRequestHeader("Content-Type","application/json"),a.send(JSON.stringify(i))}catch(e){}},function(){var e=.1;window.__hasStorage=!1;try{localStorage.setItem("testLocalStorage","ok"),localStorage.removeItem("testLocalStorage"),window.__hasStorage=!0}catch(e){}function t(e,t,n,o){var r=e.console;if(r||(r={log:function(){},error:function(){}}),e.WebSocket){if(void 0===e.jivo_magic_var){e.jivo_magic_var=!0;var i,a,s,d,l,c,u,g,f,m,v,p={hasStorage:e.__hasStorage,jivoLoaderVersion:n,loadScript:function(e,n){var o=n||t,r=o.getElementsByTagName("script")[0],i=o.createElement("script");te(i),r.parentNode.insertBefore(i,r).src=e},currentLoaderVersionCache:o},h=navigator.userAgent.toLowerCase(),w=/iPhone|iPad|iPod|Android|Windows Phone/i.test(h),_=t.createElement("iframe"),b=t.createElement("div"),y=0,S=0,j=0,C=[],I=!1,T=!1,E=U(),L=JSON.parse('["AF","CG","CF","GW","ER","IR","IQ","KP","LR","LB","LY","ML","CU","PS","SO","SD","SY","ZW","YE"]')||null,N=JSON.parse('["127-129-12k-12i-12c-12h","12e-12i-12e-124-12c-12h","131-12e-12l-12m-124-12b-12c","124-12g-12o-129-12m-124-12g-12c-12h","127-124-12s-12c-12s","12g-124-12k-12c-12p-12n-124-12h-124","3n-12j-124-12d-12l","12g-129-12o-129-128-12k-12i-12h"]')||null;ae("Initialization"),e.__jivoBundleOnLoad=function(e){clearTimeout(l),c=e;var n=((new Date).getTime()-u)/1e3;n>6&&D("loadTime",n),D("bundleLoaded",!0),D("buildNumber",i.build_number),ae("Bundle is loaded"),d=t.body.lastChild,b.style&&(b.style.opacity="0",b.style.visibility="hidden"),b.setAttribute("id","jivo-iframe-container"),b.appendChild(_),d?d.parentNode.insertBefore(b,d.nextSibling):t.body.appendChild(b),q()},e.__jivoBundleInit=function(e){e.loaderContext=p,function(){c=null;var e=function(e){if(e){var t=e.querySelectorAll&&e.querySelectorAll(".js-jivo-bundle");return t&&t.length>0?t:e.getElementsByClassName("js-jivo-bundle")}}(se());if(!e)throw r.error("Cannot get bundle script element"),new Error("Cannot get bundle script element");for(var t=0;t<e.length;t++)e[t].parentNode&&e[t].parentNode.removeChild(e[t]);e=null}()},e.jivo_init=function(){y=0;var n=t.createEvent("Event");n.initEvent("jBeforeunload",!0,!0),e.dispatchEvent(n),M()},e.jivo_destroy=function(){y=0;var n=t.createEvent("Event");n.initEvent("jBeforeunload",!0,!0),e.dispatchEvent(n),delete e.jivo_magic_var,setTimeout((function(){b.parentNode.removeChild(b)}),10)},p.getHostURL=re,p.loadConfig=x,p.store=E,p.setInStore=D;var O=!1,A=function(e){try{e.blockedURI&&-1!==e.blockedURI.indexOf("jivosite")&&(O=!0,t.removeEventListener("securitypolicyviolation",A))}catch(e){}}.bind(this);try{ie(t,"securitypolicyviolation",A)}catch(e){}B("loader_loaded",5),z(),(E=U()).geoWidgetInfo.widgetId&&(f=E.geoWidgetInfo.widgetId,E=U(),g=E.configHost),D("isNewCode",T),p.store=E;var k=null;m&&(v=m.getAttribute("nonce"))&&(e.jivo_cspNonce=v),f&&g?(ae("widgetId:",f,"configHost:",g),x(G())):f&&g||(B("no_widget_id_or_confighost",5),r.error("Failed to evaluate the widgetId or configHost"))}}else r.log("Not supported browser");function x(t,n){if(C.push(t),++j>4){ae("Config load limit is exceeded"),p.hasStorage&&localStorage.removeItem("jv_loader_info_"+f);var o=new Error("Config load limit is exceeded"),i="Config urls: "+C.join(";\r\n");try{o.stack=i}catch(e){o=new Error("Config load limit is exceeded. "+i)}e.__jivoOnError(o)}else if(ae("Loading config from",t),E.deletedInfo.widgetId&&E.deletedInfo.widgetId===f&&E.deletedInfo.resolveTime&&parseInt(E.deletedInfo.resolveTime)>=(new Date).getTime())r.error("This widget is permanently removed");else{var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4===a.readyState)if(200===a.status){var e=ue(ne(a));e?(ae("Config is loaded",e),e.isDeleted?Q():n?(e.chat_mode=n.chat_mode,e.options=n.options,e.botmode=n.botmode,e.geoip=n.geoip,e.maintenance=!!n.maintenance,R(e,null)):function(e,t){var n=new XMLHttpRequest;function o(){return!1}n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){var o=ue(ne(n));if(!o)throw new Error("Load widget status error");var r=n.getResponseHeader("X-BotMode"),i=n.getResponseHeader("X-GeoIP"),a=o.agents&&o.agents.length;ae("Status is loaded",o,r,i,a),e.botmode="yes"===r?"yes":null,e.geoip=i||";;;",e.chat_mode=a?"online":"offline",e.options=o.premium?888:0,o.bots&&o.bots.length&&(e.bots=o.bots),e.maintenance=!!o.maintenance,t(o.config_updated_ts)}else if(0!==n.status)throw e.botmode=null,e.geoip=";;;",e.chat_mode="offline",e.options=0,t(null),480==n.status&&ae("Site is under maintenance, try again later."),new Error("Load widget status error: "+n.status)};var r="/configs/development/status.json",i=o()?r:P()+"//"+e.comet.host+"/widget/status/"+e.site_id+"/"+e.widget_id+"?rnd="+Math.random();n.open("GET",i,!0),n.send(null)}(e,(function(t){R(e,t)}))):$()}else 0!==a.status&&$()},a.open("GET",t,!0),a.send(null)}}function H(e){var t={event:e,widget_id:f,t:(new Date).getTime(),param1:"17.14.0"};if(-1===navigator.userAgent.search(/google/gi)&&-1===navigator.userAgent.search(/\+http:\/\/yandex\.com\/bots/gi))try{var n=P()+"//telemetry.jivosite.com/w?cb=loader";for(var o in t)n+="&"+o+"="+encodeURIComponent(t[o]);var r=new XMLHttpRequest;"withCredentials"in r?r.open("GET",n,!0):"undefined"!=typeof XDomainRequest&&(r=new XDomainRequest).open("GET",n),r.send()}catch(e){}}function B(e,t){Math.random()<=.01*t&&H(e)}function R(n,o){if(ae("checkConfig",n.config_updated_ts,o),n.isDeleted)Q();else{if(o&&n.config_updated_ts&&n.config_updated_ts!==o)return ae("update configUpdatedTs in store",o),E.configUpdatedTs=o,x(G(),n);if(n.regions&&!E.isChatStarted){var a=function(e){var t,n,o=e.regions,r=K(e.geoip);if(o){for(var i=Object.keys(o),a=0;a<i.length;a++)for(var s=o[i[a]],d=0;d<s.length;d++)if(1!=s.length||"default"!==s[d]){var l=K(s[d]);if(r.country===l.country){if(r.region===l.region)return Y(i[a],s[d],e.geoip);n||l.region||(n=Y(i[a],s[d],e.geoip))}}else t=i[a];if(n)return n;if(t)return Y(t,"default",e.geoip)}}(n);if(a.widgetId!==f)return ae("Wrong geo-widget widgetId",f),D("geoWidgetInfo",a),f=a.widgetId,void x(G())}if((k=n.ab_segment)&&k.name&&k.host&&k.staticHost&&1!==n.site_id)if(ae("AB-testing segmentation is enabled in config"),function(e,t){var n=E.abTesting,o=!1;return o=n&&n.name===e.name?n.match:function(e,t){return ae('Check for criteria match of test "'+e.name+'"'),e.device&&!("desktop"===(n=e.device)?le()&&!ce():"mobile"===n?ce():"all"===n&&(le()||ce()))?(ae('Segment "'+e.name+'" is NOT matched. Criteria: device'),!1):e.locale&&e.locale!==t.locale?(ae('Segment "'+e.name+'" is NOT matched. Criteria: locale'),!1):!e.percentage||(o=e.percentage,Math.random()<=.01*o)?(ae('Segment "'+e.name+'" is matched!'),!0):(ae('Segment "'+e.name+'" is NOT matched. Criteria: percentage'),!1);var n,o}(e,t),D("abTesting",{name:e.name,match:o}),o}(k,n)){ae("Ab-testing segment match! Segment:",k.name);var s="//"+k.host;ae('Setting new base_url. Was: "'+n.base_url+'". New: "'+s+'".'),n.base_url=s,ae('Setting new static_host. Was: "'+n.static_host+'". New: "'+k.staticHost+'".'),n.static_host=k.staticHost}else ae("Ab-testing segment is NOT matched");else D("abTesting",null),ae("AB-testing segmentation is NOT enabled in config"),D("configHost",g);!function(n){if(D("log",!!n.logs),e.jivo_config=i=n,function(){if(i.host_blacklist)for(var t=i.host_blacklist.split(","),n=0;n<t.length;n++)if(e.location.host.indexOf(t[n].replace(" ",""))>=0)return!0;return!1}())throw ae("Host is blacklisted",e.location.host),new Error("Placing widget is forbidden on "+e.top.location.host);if(g=i.geoip.split(";")[0],L.indexOf(g)>=0)return r.log("[Jivo]: Service unavailable for country");if(!n.disable_stop_words&&(o=!1,a=N.map((function(e){return e.split("-").map((function(e){return String.fromCharCode(parseInt(e,32)-20)})).join("")})),s=t.querySelector('meta[name="description"]'),d=t.querySelector('meta[name="keywords"]'),l=t.title,c=s&&s.content?s.content:"",u=d&&d.content?d.content:"",(oe(l,a)||oe(c,a)||oe(u,a))&&(o=!0),o))return H("error_code_1015"),void ae("Init error, code 1015.");var o,a,s,d,l,c,u,g;w&&i.disable_mobile?ae("Mobile widget is disabled"):(i.static_host&&(~i.static_host.search(/\/\/cdn(-\w+)?.jivosite.com(\/\w)?/)||~i.static_host.search(/\/\/code(-\w+)?.jivosite.com(\/\w)?/))&&(I=!0),ae("isCdnProvider: ",I),"complete"==t.readyState?W():E.bundleLoaded&&E.buildNumber==i.build_number?"interactive"==t.readyState?W():ie(e,"DOMContentLoaded",W):(D("bundleLoaded",!1),ie(e,"load",W)))}(n)}}function W(){ae("Widget initialization"),ae("Iframe initialization"),_.src="javascript:void(0)",_.role="presentation",_.allow="autoplay",_.title="Jivochat",_.setAttribute("name","jivo_container"),_.setAttribute("id","jivo_container"),_.setAttribute("frameborder","no"),v&&_.setAttribute("nonce",v),e.atob&&"complete"!==t.readyState?ie(e,"load",M):M(),ie(e,"message",(function(t){if(t&&t.data&&"object"==typeof t.data){var n=t.data;"in_node_webkit"==n.name&&(e.jivo_cobrowse={source:t.source,origin:t.origin}),"iframe_url_changed"!=n.name&&"iframe_url_changed"!=n||q()}else i&&1===i.logs&&r&&r.log&&r.log("Error receive postMessage, window message event is empty.")}))}function M(){var n=re();ae("startLoadBundle",n),function(n){ae("Insertion of bundle code from",n);var o=se(),a=t.createElement("script"),s=function(e){var t=i.bundle_folder?i.bundle_folder:"";return e+t+"/js/bundle_"+i.locale+".js?rand="+i.build_number}(n);u=(new Date).getTime(),te(a),a.className="js-jivo-bundle",a.src=P()+s,p.bundleSrc=s,a.onerror=function(){ae("loadBundle errorBundle",n),t.getElementById("jcont")&&function(t,n,o){if(clearTimeout(l),++S>=5){if(ae("Bundle load retries count is exceeded"),ae("Bad csp is: "+O),O)return void r.error("Widget not loaded due CSP security policy.");var i=new Error("Bundle NOT loaded. Type: "+t+(n?". Host: "+n:"")+(o?". Status code: "+o:""));e.__jivoOnError(i)}else M()}("errorBundle",n)},o.appendChild(a)}(n)}function q(){if(!(y++>3)){if(!c)return y--,M();try{s=_.contentWindow.document}catch(e){a=t.domain,_.src="javascript:var d=document.open();d.domain='"+a+"';void(0);",s=_.contentWindow.document}var e='<meta name="google" content="notranslate"><meta http-equiv="X-UA-Compatible" content="IE=edge" />',n="window.onerror = function (message, url, lineNumber, columnNumber, error) {\n                    if (error && error.error) {\n                        error = error.error;\n                    }\n                \n                    if (!error || !(error instanceof Error)) {\n                        error = {};\n                    }\n                \n                    error.stack = error.stack || 'empty';\n                    error.message = 'Bundle init error: ' + message + ' error.message: ' + error.message;\n                    error.columnNumber = columnNumber;\n                    error.lineNumber = lineNumber;\n                    error.url = url;\n                \n                    window.parent.__jivoOnError(error);\n                };"+c;if(navigator.userAgent.toLowerCase().indexOf("firefox")>-1||!s.head||!s.body){var o='<body class="notranslate"></body>',r='<script type="text/javascript"'+(v?'nonce="'+v+'"':"")+">"+n+"<\/script>",i="<head>"+e+r+"</head>";s.write("<!doctype HTML>"+i+o),r=null,o=null,i=null}else{s.body.class="notranslate",s.head.innerHTML=e;var d=t.createElement("script");d.type="text/javascript",v&&d.setAttribute("nonce",v),d.innerHTML=n,s.head.appendChild(d)}s.close(),n=null}}function U(){var e={isChatStarted:null,geoWidgetInfo:{widgetId:null,clientLocation:null,region:null},configHost:null,deletedInfo:{widgetId:null,resolveTime:null},abTesting:null,buildNumber:null,bundleLoaded:null,isNewCode:null,loadTime:null,log:null,configUpdatedTs:null};if(p.hasStorage&&(localStorage.removeItem("jv_loader_info"),f)){var t=ue(localStorage.getItem("jv_loader_info_"+f));t&&J(t,e)}return e}function D(t,n){if(E[t]=n,p.hasStorage&&f){var o={};J(E,o),localStorage.setItem("jv_loader_info_"+f,(r=o,e.MooTools&&void 0===JSON.stringify?JSON.encode(r):JSON.stringify(r)))}var r}function J(e,t){Object.keys(e).forEach((function(n){(function(e){if(X(e))return!0;if("object"==typeof e){for(var t=Object.keys(e),n=0;n<t.length;n++)if(!X(e[t[n]]))return!1;return!0}})(e[n])||(t[n]=e[n])}))}function X(e){return null===e&&"object"==typeof e}function P(){var t=e.location&&e.location.protocol;return-1===["http","https"].indexOf(t||"")&&(t="https:"),t}function G(){var e="";return ae("getConfigUrl",E.configUpdatedTs),E.configUpdatedTs&&(e="?v="+E.configUpdatedTs),P()+g+"/script/widget/config/"+f+e}function z(){m=t.currentScript?t.currentScript:t.querySelector("script[jv-id]")||t.querySelector("script[data-jv-id]");var e,n=function(){if(m)return m.src;try{throw new Error("Get script URL")}catch(r){var e=r.stack;if(e){var t=V(e),n=F(e),o=Z(e);return t?t[0]:n?n[0]:o?o[0]:null}}}(),o=V(n),r=F(n),i=Z(n);g||(o?(g="//"+o[1],T=!0):r?g="//"+r[1]:i&&(g="//"+i[1])),f||(r&&r[2]?(f=r[2],T=!1):i&&i[2]?(f=i[2],T=!1):(T=!0,m&&(f=m.getAttribute("jv-id")||m.getAttribute("data-jv-id")),f||(e=n.match(/https?:\/\/\S+\/widget\/([A-Za-z0-9]+)/),f=e?e[1]:null)))}function V(e){return e&&e.match(/https?:\/\/(\S+\.com)\/(widget\.js|widget\/[A-Za-z0-9]+)/)}function F(e){return e&&e.match(/https?:\/\/(\S+)\/script\/widget\/([A-Za-z0-9]+)/)}function Z(e){return e&&e.match(/https?:\/\/(\S+)\/script\/geo-widget\/([A-Za-z0-9]+)/)}function Y(e,t,n){return{widgetId:e,region:t,clientLocation:n}}function K(e){if("string"==typeof e&&""!==e){var t=e.split(";");return{country:t[0],region:t[1],city:t[2]}}}function Q(){ae("Widget was removed",f),D("configHost",null),E.geoWidgetInfo.widgetId||E.isChatStarted?(D("geoWidgetInfo",Y(null,null,null)),D("isChatStarted",null),ee()):(D("deletedInfo",{widgetId:f,resolveTime:((new Date).getTime()+6048e5).toString()}),r.error("Widget "+f+" is permanently removed. Host: "+g),H("widget_deleted"))}function $(){ae("Config loading error"),D("geoWidgetInfo",Y(null,null,null)),D("isChatStarted",null),D("configHost",null),ee()}function ee(){f=null,g=null,z(),x(G())}function te(e){if(e)return e.type="text/javascript",e.async=!0,e.charset="UTF-8",v&&e.setAttribute("nonce",v),e}function ne(e){return e.responseType&&"text"!==e.responseType?"document"===e.responseType?e.responseXML:e.response:e.responseText}function oe(e,t){for(var n=!1,o=0;o<t.length;o++){var r=t[o].toLowerCase(),i=new RegExp("([, .]|^)"+r+"([, .]|$)","gi");if(e.toLowerCase().search(i)>-1){n=!0;break}}return n}function re(){return I?i.static_host:i.base_url}function ie(t,n,o){var r;t.addEventListener?t.addEventListener(n,o,!1):t.attachEvent&&(t.attachEvent("on"+n,(r=t,function(){o.call(r,e.event)})),t=null)}function ae(){if(E.log){var e=Array.prototype.slice.call(arguments||[]);e.unshift("Loader:"),r.log.apply(r,e)}}function se(){var e=t.head||t.getElementsByTagName("head")[0];if(!e)throw r.error("Cannot get document head element"),new Error("Cannot get document head element");return e}function de(e){return-1!==h.indexOf(e)}function le(){return de("chrome")&&!de("opr/")&&"Google Inc."===e.navigator.vendor}function ce(){return!de("windows")&&de("android")}function ue(t){try{return e.MooTools&&void 0===JSON.parse?JSON.decode(t):JSON.parse(t)}catch(e){return null}}}var n=t,o=null;if(window.__hasStorage){try{o=JSON.parse(localStorage.getItem("__jivoLoader"))}catch(e){e.message="Loader parse error",window.__jivoOnError(e)}o&&o.version>e&&(n=new Function("window","document","broswerCacheLoaderVersion","currentLoaderVersionCache","("+o.code+")(window, document, broswerCacheLoaderVersion, currentLoaderVersionCache)"))}try{n(window,document,e,o?o.version:e)}catch(o){o.message=o.message?"Loader error. "+o.message:"Loader error",window.__jivoOnError(o),delete window.jivo_magic_var,(n=t)(window,document,e,e)}}();